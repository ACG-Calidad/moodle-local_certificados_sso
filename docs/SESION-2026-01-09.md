# Sesi√≥n de Trabajo - 9 de Enero 2026
## Configuraci√≥n Local de Moodle 5.1 e Instalaci√≥n de Plugin SSO

**Fecha:** 2026-01-09
**Duraci√≥n:** ~4 horas
**Desarrollador:** Oliver Castelblanco

---

## üìã Objetivos de la Sesi√≥n

1. Clonar ambiente Green (AWS) a ambiente local Docker
2. Instalar plugin `local_certificados_sso` en Moodle local
3. Resolver errores de configuraci√≥n y compatibilidad
4. Aplicar recomendaciones de Moodle 5.1
5. Documentar proceso y crear scripts de utilidad

---

## üî® Trabajo Realizado

### 1. Configuraci√≥n Inicial de Moodle Local

#### 1.1 Problemas Encontrados y Soluciones

**Problema 1: Error E_STRICT Deprecated (PHP 8.4)**
```
Deprecated: Constant E_STRICT is deprecated in /var/www/html/config.php on line 41
```

**Soluci√≥n:**
- Actualizado [config.php](../moodle-files/config.php:292-295) para remover `E_STRICT`
- PHP 8.4 deprec√≥ esta constante, ahora solo se usa `E_ALL`

```php
// Antes:
$CFG->debug = (E_ALL | E_STRICT);
@error_reporting(E_ALL | E_STRICT);

// Despu√©s:
$CFG->debug = E_ALL;
@error_reporting(E_ALL);
```

---

**Problema 2: Redirect a /public/**

**Causa:**
- Moodle 5.1 tiene nueva estructura de directorios con carpeta `public/`
- `APACHE_DOCUMENT_ROOT` estaba configurado como `/var/www/html`
- Esto causaba que Apache sirviera el `index.php` ra√≠z que redirige a `./public/`

**Soluci√≥n:**
- Actualizado [docker-compose.yml](../docker-compose.yml:45)
- Cambiado `APACHE_DOCUMENT_ROOT` de `/var/www/html` a `/var/www/html/public`

```yaml
environment:
  - APACHE_DOCUMENT_ROOT=/var/www/html/public
```

---

**Problema 3: Class "cache" Not Found**

**Causa:**
- El script `clone-green-to-local.sh` ten√≠a `--exclude='cache'` en rsync
- Esto excluy√≥ **TODAS** las carpetas cache, incluyendo c√≥digo fuente:
  - `public/cache/` (subsistema de cache de Moodle - C√ìDIGO)
  - `*/classes/cache/` (datasources de m√≥dulos - C√ìDIGO)
  - No solo los directorios de datos como `moodledata/cache/`

**Soluci√≥n:**
- Copiado manualmente `public/cache/` desde Green
- Copiado todos los `*/classes/cache/` faltantes:
  - `ai/classes/cache/policy.php`
  - `course/classes/cache/course_image.php`
  - `mod/quiz/classes/cache/overrides.php`
  - `mod/assign/classes/cache/overrides.php`
  - `mod/lesson/classes/cache/overrides.php`
  - `mod/scorm/classes/cache/elements.php`
  - `theme/boost_union/classes/cache/loader.php`

---

**Problema 4: Undefined Property $libdir**

**Causa:**
- Moodle 5.1 requiere `$CFG->libdir` expl√≠citamente definido
- El helper de migraci√≥n en `/lib/setup.php` lo espera

**Soluci√≥n:**
- Agregado a [config.php](../moodle-files/config.php:363-364):

```php
$CFG->dirroot   = '/var/www/html';
$CFG->libdir    = $CFG->dirroot . '/lib';
```

---

**Problema 5: LocalCache Directory Missing**

**Causa:**
- Moodle 5.1 requiere `$CFG->localcachedir` para el sistema de cach√© local

**Soluci√≥n:**
- Agregado a [config.php](../moodle-files/config.php:378):

```php
$CFG->localcachedir = '/var/www/moodledata/localcache';
```

---

### 2. Aplicaci√≥n de Recomendaciones de Moodle

#### 2.1 Instalaci√≥n de Extensi√≥n SOAP

**Recomendaci√≥n:**
```
The SOAP extension is not available. This is required for communicating with external web services.
```

**Soluci√≥n:**
- Actualizado [Dockerfile](../docker/php/Dockerfile:45) para incluir SOAP:

```dockerfile
RUN docker-php-ext-install \
    pdo \
    pdo_mysql \
    mysqli \
    mbstring \
    zip \
    exif \
    pcntl \
    bcmath \
    intl \
    opcache \
    soap  # AGREGADO
```

- Reconstruido imagen Docker: `docker-compose build moodle`

---

#### 2.2 Configuraci√≥n max_input_vars

**Recomendaci√≥n:**
```
max_input_vars should be at least 5000
```

**Soluci√≥n:**
- Actualizado [php.ini](../docker/php/php.ini:20):

```ini
max_input_vars = 5000
```

---

#### 2.3 Configuraci√≥n zend.exception_ignore_args

**Recomendaci√≥n:**
```
For additional security, we recommend enabling zend.exception_ignore_args
```

**Soluci√≥n:**
- Actualizado [php.ini](../docker/php/php.ini:74):

```ini
zend.exception_ignore_args = On
```

---

#### 2.4 Correcci√≥n de Configuraci√≥n mbstring (PHP 8.4)

**Problema:**
- `mbstring.language` y `mbstring.internal_encoding` est√°n deprecated en PHP 8.4

**Soluci√≥n:**
- Removidas directivas obsoletas de [php.ini](../docker/php/php.ini:53-56)
- Agregado `default_charset = "UTF-8"` como reemplazo

```ini
; Removido (deprecated):
; mbstring.language = Spanish
; mbstring.internal_encoding = UTF-8

; Agregado:
default_charset = "UTF-8"
```

---

### 3. Instalaci√≥n del Plugin SSO

#### 3.1 Error de Versi√≥n de Moodle

**Problema:**
```
Plugin requires Moodle 2025102700
Installed: 2025100600
Status: Failed
```

**Causa:**
- El [version.php](../moodle-plugin/version.php:15) del plugin ten√≠a versi√≥n incorrecta
- Requer√≠a `2025102700` pero Green tiene `2025100600`

**Soluci√≥n:**
- Actualizado version.php:

```php
$plugin->requires  = 2025100600;  // Cambiado de 2025102700
$plugin->version   = 2026010900;  // Incrementado de 2026010800
```

---

#### 3.2 Error de Language Strings

**Problema:**
```
Invalid get_string() identifier: 'pluginname,local_certificados_sso'
Invalid get_string() identifier: 'appurl,local_certificados_sso'
... (m√∫ltiples errores)
```

**Causa:**
- Archivo de idioma no exist√≠a: `lang/en/local_certificados_sso.php`

**Soluci√≥n:**
- Creado [lang/en/local_certificados_sso.php](../moodle-plugin/lang/en/local_certificados_sso.php) con todos los strings:

```php
$string['pluginname'] = 'ACG Certificados SSO';
$string['appurl'] = 'Production App URL';
$string['appurl_desc'] = 'URL of the certificates application in production environment';
$string['devurl'] = 'Development App URL';
$string['devurl_desc'] = 'URL of the certificates application for local development';
$string['tokenexpiry'] = 'Token Expiry Time';
$string['tokenexpiry_desc'] = 'Time in seconds before SSO tokens expire (default: 300)';
$string['debugmode'] = 'Debug Mode';
$string['debugmode_desc'] = 'Enable debug logging for SSO operations';
$string['mycertificates'] = 'My Certificates';
```

- Copiado al directorio instalado en Moodle:
  `moodle-files/public/local/certificados_sso/lang/en/`

---

### 4. Actualizaci√≥n de Scripts y Documentaci√≥n

#### 4.1 Actualizaci√≥n de clone-green-to-local.sh

**Cambios realizados en [scripts/clone-green-to-local.sh](../scripts/clone-green-to-local.sh):**

1. **Correcci√≥n de URL de RDS** (l√≠nea 25):
```bash
# Antes:
RDS_HOST="acgdb.c2uujyoezwbf.us-east-1.rds.amazonaws.com"

# Despu√©s:
RDS_HOST="acgdb.c9f1mlfzllkw.us-east-1.rds.amazonaws.com"
```

2. **Correcci√≥n de exclusiones de rsync** (l√≠neas 194-203):
```bash
# Antes:
--exclude='cache' \  # Exclu√≠a TODO lo que contuviera "cache"

# Despu√©s:
--exclude='moodledata/cache' \      # Solo excluir DATA cache
--exclude='moodledata/localcache' \
--exclude='moodledata/sessions' \
--exclude='moodledata/temp' \
```

3. **Actualizaci√≥n de config.php generado** (l√≠neas 322-384):
- Agregado `$CFG->dirroot` y `$CFG->libdir`
- Removido `E_STRICT`
- Agregado `$CFG->localcachedir`
- Agregado comentario final sobre closing tag

---

#### 4.2 Actualizaci√≥n de SETUP-LOCAL-MOODLE.md

**Cambios realizados en [docs/SETUP-LOCAL-MOODLE.md](../docs/SETUP-LOCAL-MOODLE.md):**

1. **Secci√≥n 5.1 - config.php** (l√≠neas 283-307):
   - Agregado `$CFG->dirroot` y `$CFG->libdir`
   - Removido `E_STRICT`
   - Agregado `$CFG->localcachedir`

2. **Secci√≥n 5.2 - docker-compose.yml** (l√≠nea 337):
   - Cambiado `APACHE_DOCUMENT_ROOT` a `/var/www/html/public`

3. **Secci√≥n 6.3 - Referencia a manual** (l√≠nea 401):
   - Actualizado link de `INSTALL-GREEN.md` a `MANUAL-CONFIGURACION-PLUGIN.md`

---

#### 4.3 Creaci√≥n de MANUAL-CONFIGURACION-PLUGIN.md

**Nuevo archivo:** [docs/MANUAL-CONFIGURACION-PLUGIN.md](../docs/MANUAL-CONFIGURACION-PLUGIN.md)

**Contenido:**
- Manual simplificado para usuarios no t√©cnicos
- Enfocado solo en la configuraci√≥n del plugin (pasos 1-5)
- Asume que el plugin ya est√° instalado
- Incluye troubleshooting espec√≠fico
- Formato claro con capturas de pantalla sugeridas

**Secciones principales:**
1. Habilitar Web Services
2. Configurar el Servicio Web
3. Crear Token para el Backend
4. Configurar URLs del Plugin
5. Verificar Instalaci√≥n
6. Soluci√≥n de Problemas
7. Informaci√≥n de Seguridad

---

#### 4.4 Creaci√≥n de reset-database.sh

**Nuevo script:** [scripts/reset-database.sh](../scripts/reset-database.sh)

**Funcionalidad:**
- Permite resetear la BD local a un backup espec√≠fico
- √ötil para pruebas donde necesitas volver al estado inicial
- Crea backup de seguridad antes de resetear
- Purga cach√©s autom√°ticamente despu√©s del reset

**Uso:**
```bash
# Usar backup m√°s reciente
./reset-database.sh

# Usar backup de fecha espec√≠fica
./reset-database.sh 20260109
```

**Caracter√≠sticas:**
- Confirmaci√≥n obligatoria antes de proceder
- Backup de seguridad autom√°tico
- Validaciones de Docker y contenedores
- Output colorido y amigable
- Descompresi√≥n autom√°tica de .gz
- Purga de cach√©s de Moodle
- Resumen final con estad√≠sticas

---

## üìä Resumen de Archivos Modificados

### Archivos de Configuraci√≥n

| Archivo | Cambios |
|---------|---------|
| [moodle-files/config.php](../moodle-files/config.php) | ‚úÖ Agregado dirroot/libdir<br>‚úÖ Removido E_STRICT<br>‚úÖ Agregado localcachedir |
| [docker/php/php.ini](../docker/php/php.ini) | ‚úÖ max_input_vars = 5000<br>‚úÖ zend.exception_ignore_args = On<br>‚úÖ Removido mbstring deprecated |
| [docker/php/Dockerfile](../docker/php/Dockerfile) | ‚úÖ Agregado extensi√≥n SOAP |
| [docker-compose.yml](../docker-compose.yml) | ‚úÖ APACHE_DOCUMENT_ROOT=/var/www/html/public |

### Plugin

| Archivo | Cambios |
|---------|---------|
| [moodle-plugin/version.php](../moodle-plugin/version.php) | ‚úÖ requires = 2025100600<br>‚úÖ version = 2026010900 |
| [moodle-plugin/lang/en/local_certificados_sso.php](../moodle-plugin/lang/en/local_certificados_sso.php) | ‚úÖ **NUEVO** - Archivo de idioma |

### Scripts

| Archivo | Cambios |
|---------|---------|
| [scripts/clone-green-to-local.sh](../scripts/clone-green-to-local.sh) | ‚úÖ URL RDS corregida<br>‚úÖ Exclusiones rsync corregidas<br>‚úÖ config.php actualizado |
| [scripts/reset-database.sh](../scripts/reset-database.sh) | ‚úÖ **NUEVO** - Script de reset |

### Documentaci√≥n

| Archivo | Cambios |
|---------|---------|
| [docs/SETUP-LOCAL-MOODLE.md](../docs/SETUP-LOCAL-MOODLE.md) | ‚úÖ config.php actualizado<br>‚úÖ docker-compose actualizado<br>‚úÖ Referencias corregidas |
| [docs/MANUAL-CONFIGURACION-PLUGIN.md](../docs/MANUAL-CONFIGURACION-PLUGIN.md) | ‚úÖ **NUEVO** - Manual para usuarios |
| [docs/SESION-2026-01-09.md](../docs/SESION-2026-01-09.md) | ‚úÖ **NUEVO** - Este documento |

---

## üéØ Estado Actual del Proyecto

### ‚úÖ Completado

- [x] Ambiente Docker local configurado y funcionando
- [x] Moodle 5.1 clonado desde Green
- [x] Base de datos restaurada (400+ tablas)
- [x] Todos los errores de PHP y Moodle resueltos
- [x] Todas las recomendaciones de Moodle aplicadas
- [x] Plugin SSO instalado correctamente
- [x] Archivos de idioma creados
- [x] Scripts actualizados y funcionando
- [x] Documentaci√≥n completa y actualizada

### üîÑ En Progreso (Paso 4 del Manual)

- [ ] Configurar Web Services en Moodle
- [ ] Crear servicio "ACG Certificados SSO"
- [ ] Generar token permanente
- [ ] Configurar URLs del plugin

---

## üìù Tareas Pendientes para Ma√±ana

### 1. Completar Configuraci√≥n del Plugin (Alta Prioridad)

**Seguir el manual [MANUAL-CONFIGURACION-PLUGIN.md](../docs/MANUAL-CONFIGURACION-PLUGIN.md):**

#### Paso 1: Habilitar Web Services
- [ ] Ir a `Administraci√≥n del sitio ‚Üí Funcionalidades avanzadas`
- [ ] Marcar ‚òëÔ∏è "Habilitar servicios web"
- [ ] Guardar cambios

#### Paso 2: Activar Protocolo REST
- [ ] Ir a `Administraci√≥n del sitio ‚Üí Servidor ‚Üí Servicios web ‚Üí Gestionar protocolos`
- [ ] Habilitar "REST protocol"

#### Paso 3: Crear Servicio Web
- [ ] Ir a `Administraci√≥n del sitio ‚Üí Servidor ‚Üí Servicios web ‚Üí Servicios externos`
- [ ] Crear servicio "ACG Certificados SSO"
- [ ] Agregar funciones:
  - `local_certificados_sso_generate_token`
  - `local_certificados_sso_validate_token`

#### Paso 4: Crear Token
- [ ] Ir a `Administraci√≥n del sitio ‚Üí Servidor ‚Üí Servicios web ‚Üí Gestionar tokens`
- [ ] Crear token para usuario `adminav`
- [ ] Asignar servicio "ACG Certificados SSO"
- [ ] **GUARDAR TOKEN** en lugar seguro

#### Paso 5: Configurar URLs
- [ ] Ir a `Administraci√≥n del sitio ‚Üí Plugins ‚Üí Plugins locales ‚Üí Certificados SSO`
- [ ] URL producci√≥n: `https://aulavirtual.acgcalidad.co/certificados/`
- [ ] URL desarrollo: `http://localhost:4200/`
- [ ] Token expiry: `300`
- [ ] Debug mode: ‚òëÔ∏è Activado (para desarrollo)

#### Paso 6: Verificar
- [ ] Purgar cach√©s de Moodle
- [ ] Verificar que aparece enlace "Mis Certificados"
- [ ] Verificar tarea programada de limpieza

---

### 2. Desarrollo del Backend (Alta Prioridad)

**Ubicaci√≥n:** `backend/`

#### 2.1 Configuraci√≥n Inicial
- [ ] Crear estructura de directorios del backend
- [ ] Configurar archivo `.env` con:
  - Token de Moodle (del paso 4)
  - URL de Moodle: `http://moodle:80` (dentro de Docker)
  - Credenciales de BD

#### 2.2 Endpoints Principales
- [ ] **POST /api/auth/validate-token**
  - Recibe token SSO desde frontend
  - Valida token contra Moodle Web Service
  - Retorna informaci√≥n del usuario

- [ ] **GET /api/certificates/user/:userid**
  - Lista certificados del usuario
  - Consulta BD de Moodle
  - Retorna JSON con certificados

- [ ] **GET /api/certificates/:id/download**
  - Descarga PDF del certificado
  - Desde storage o genera on-the-fly

#### 2.3 Testing
- [ ] Probar validaci√≥n de token con Postman
- [ ] Probar consulta de certificados
- [ ] Probar descarga de PDF

---

### 3. Desarrollo del Frontend (Media Prioridad)

**Ubicaci√≥n:** `frontend/`

#### 3.1 Componentes Principales
- [ ] **LoginComponent** (autom√°tico con SSO)
  - Captura token de URL
  - Env√≠a a backend para validaci√≥n
  - Guarda sesi√≥n

- [ ] **CertificatesListComponent**
  - Lista certificados del usuario
  - Filtros y b√∫squeda
  - Bot√≥n de descarga

- [ ] **CertificateDetailComponent** (opcional)
  - Vista previa del certificado
  - Informaci√≥n detallada

#### 3.2 Servicios
- [ ] **AuthService**
  - Validar token SSO
  - Mantener sesi√≥n
  - Logout

- [ ] **CertificatesService**
  - Listar certificados
  - Descargar PDF

---

### 4. Testing de Integraci√≥n (Alta Prioridad)

#### 4.1 Flujo Completo SSO
- [ ] Usuario en Moodle hace clic en "Mis Certificados"
- [ ] Plugin genera token SSO
- [ ] Redirige a frontend con token en URL
- [ ] Frontend env√≠a token a backend
- [ ] Backend valida con Moodle
- [ ] Frontend muestra certificados

#### 4.2 Casos de Prueba
- [ ] Token v√°lido ‚Üí Login exitoso
- [ ] Token expirado ‚Üí Error y redirect a Moodle
- [ ] Token inv√°lido ‚Üí Error y redirect a Moodle
- [ ] Usuario sin certificados ‚Üí Vista vac√≠a
- [ ] Usuario con certificados ‚Üí Lista correcta
- [ ] Descarga de PDF ‚Üí Funciona

---

### 5. Migraci√≥n de Datos Legacy (Baja Prioridad)

**Script de migraci√≥n:** `backend/scripts/migrate-legacy-certificates.php`

- [ ] Analizar estructura de tabla legacy
- [ ] Mapear campos a nueva estructura
- [ ] Crear script de migraci√≥n
- [ ] Probar en ambiente local
- [ ] Ejecutar en Green (1,490 registros)

---

### 6. Documentaci√≥n T√©cnica (Media Prioridad)

- [ ] **API Documentation**
  - Documentar endpoints del backend
  - Ejemplos de request/response
  - C√≥digos de error

- [ ] **Architecture Diagram**
  - Diagrama de flujo SSO
  - Diagrama de componentes
  - Diagrama de base de datos

- [ ] **Deployment Guide**
  - Pasos para desplegar a Green
  - Configuraci√≥n de Apache/Nginx
  - Variables de entorno

---

## üêõ Bugs Conocidos / Notas

### Bug en clone-green-to-local.sh
- El rsync `--exclude='cache'` es muy agresivo
- Excluye directorios de c√≥digo que tienen "cache" en el nombre
- **Temporal:** Ya corregido en el script
- **Permanente:** Considerar usar `--exclude='moodledata/cache/'` con trailing slash

### Moodle 5.1 Public Directory
- Nueva estructura de directorios en Moodle 5.1
- C√≥digo en `/var/www/html`
- Web root en `/var/www/html/public`
- Helper autom√°tico en `/lib/setup.php` maneja migraci√≥n

### PHP 8.4 Compatibility
- Varias constantes y configuraciones deprecated
- `E_STRICT` removido
- `mbstring.internal_encoding` removido
- Revisar documentaci√≥n de PHP 8.4 para otras deprecations

---

## üí° Lecciones Aprendidas

### 1. Verificar Estructura de Archivos
- No asumir que rsync con `--exclude` solo excluye data
- Siempre revisar qu√© archivos se est√°n excluyendo
- Mejor ser espec√≠fico con paths completos

### 2. Leer Release Notes
- Moodle 5.1 tiene cambios significativos en estructura
- Nuevos requisitos de configuraci√≥n (`localcachedir`)
- PHP 8.4 tiene muchas deprecations

### 3. Language Files son Obligatorios
- Moodle NO renderiza nada sin language strings
- Crear archivo de idioma desde el inicio del plugin
- Incluir todos los strings que se usen en el c√≥digo

### 4. Documentar Durante el Desarrollo
- Este documento es invaluable para debugging futuro
- Guardar comandos exactos que se ejecutaron
- Documentar errores Y soluciones

---

## üìû Contactos y Referencias

### URLs Importantes
- **Moodle Local:** http://localhost:8082
- **Backend API:** http://localhost:8080
- **phpMyAdmin:** http://localhost:8081
- **Moodle Docs:** https://docs.moodle.org/51/en/

### Credenciales
- **Moodle adminav:** `4dm1n1str4d0rM00dl3!`
- **MariaDB root:** `root_password_dev`
- **MariaDB moodle_user:** `moodle_password_dev`

### Repositorios
- **GitHub:** (pendiente crear)
- **Docs:** `/docs/`
- **Scripts:** `/scripts/`

---

## üéâ Conclusiones

Sesi√≥n muy productiva. Se logr√≥:

1. ‚úÖ Configurar ambiente local completo y funcional
2. ‚úÖ Resolver TODOS los errores de compatibilidad
3. ‚úÖ Instalar plugin SSO exitosamente
4. ‚úÖ Crear documentaci√≥n completa
5. ‚úÖ Actualizar scripts de utilidad

**Pr√≥ximo paso inmediato:** Completar configuraci√≥n del plugin siguiendo el manual de configuraci√≥n, luego iniciar desarrollo del backend.

**Tiempo estimado para completar configuraci√≥n:** 30-45 minutos

**Tiempo estimado para backend b√°sico:** 4-6 horas

---

*Documentado por: Oliver Castelblanco*
*Fecha: 2026-01-09*
*Pr√≥xima sesi√≥n: 2026-01-10*
