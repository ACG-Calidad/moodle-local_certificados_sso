# SesiÃ³n de Trabajo - 10 de Enero 2026
## Completar ConfiguraciÃ³n del Plugin SSO y Ajustes Finales

**Fecha:** 2026-01-10
**DuraciÃ³n:** ~2 horas
**Desarrollador:** Oliver Castelblanco

---

## ğŸ“‹ Objetivos de la SesiÃ³n

1. Completar configuraciÃ³n del plugin SSO siguiendo el manual
2. Resolver errores de language strings
3. Ajustar visualizaciÃ³n del enlace en Boost Union theme
4. Configurar modo debug apropiado
5. Personalizar comportamiento del enlace "Mis Certificados"

---

## ğŸ”¨ Trabajo Realizado

### 1. ConfiguraciÃ³n del Plugin SSO (Manual Steps)

#### 1.1 Habilitar Web Services

**Pasos realizados:**
- âœ… Ir a `AdministraciÃ³n del sitio â†’ Servidor â†’ Servicios Web â†’ Vista general`
- âœ… Verificar que Web Services estaban habilitados
- âœ… Activar protocolo REST

**Estado:** Completado sin errores

---

#### 1.2 Crear Servicio Web "ACG Certificados SSO"

**Pasos realizados:**
- âœ… Ir a `AdministraciÃ³n del sitio â†’ Servidor â†’ Servicios web â†’ Servicios externos`
- âœ… Crear servicio con nombre: `ACG Certificados SSO`
- âœ… Nombre corto: `acg_certificados_sso`
- âœ… Habilitado: SÃ­

**Problema encontrado:**
```
Invalid get_string() identifier: 'certificados_sso:generatetoken'
Invalid get_string() identifier: 'certificados_sso:validatetoken'
Invalid get_string() identifier: 'certificados_sso:manage'
```

**Causa:**
- Faltaban language strings para las capabilities del plugin

**SoluciÃ³n:**
- Agregados strings faltantes a [lang/en/local_certificados_sso.php](../moodle-plugin/lang/en/local_certificados_sso.php:27-30):

```php
// Capabilities
$string['certificados_sso:generatetoken'] = 'Generate SSO token for certificates application';
$string['certificados_sso:validatetoken'] = 'Validate SSO tokens from certificates application';
$string['certificados_sso:manage'] = 'Manage certificates SSO plugin settings';
```

---

#### 1.3 Agregar Funciones al Servicio

**Pasos realizados:**
- âœ… Agregar funciÃ³n: `local_certificados_sso_generate_token`
- âœ… Agregar funciÃ³n: `local_certificados_sso_validate_token`
- âœ… Verificar que el servicio muestra "2" funciones

**Problema encontrado:**
```
Invalid get_string() identifier: 'taskcleanuptokens'
```

**Causa:**
- Faltaba language string para la tarea programada

**SoluciÃ³n:**
- Agregado string a [lang/en/local_certificados_sso.php](../moodle-plugin/lang/en/local_certificados_sso.php:33):

```php
// Scheduled tasks
$string['taskcleanuptokens'] = 'Clean up expired SSO tokens';
```

---

#### 1.4 Crear Token Permanente

**Pasos realizados:**
- âœ… Ir a `AdministraciÃ³n del sitio â†’ Servidor â†’ Servicios web â†’ Gestionar tokens`
- âœ… Crear token para usuario: `adminav`
- âœ… Servicio: `ACG Certificados SSO`
- âœ… Sin fecha de vencimiento (token permanente)

**Token generado:** *(guardado de forma segura)*

---

#### 1.5 Configurar URLs del Plugin

**Pasos realizados:**
- âœ… Ir a `AdministraciÃ³n del sitio â†’ Extensiones â†’ Extensiones locales â†’ Certificados SSO`
- âœ… URL producciÃ³n: `https://aulavirtual.acgcalidad.co/certificados/`
- âœ… URL desarrollo: `http://localhost:4200/`
- âœ… Token expiry: `300` segundos
- âœ… Debug mode: â˜‘ï¸ Activado (para desarrollo local)

**Estado:** ConfiguraciÃ³n guardada exitosamente

---

### 2. Problemas con VisualizaciÃ³n del Enlace

#### 2.1 Enlace "Mis Certificados" No Aparece

**Problema inicial:**
- DespuÃ©s de purgar cachÃ©s y seguir todos los pasos del manual
- El enlace "Mis Certificados" NO aparecÃ­a en el menÃº principal
- Usando tema Boost Union

**DiagnÃ³stico:**
1. Agregado cÃ³digo de debugging en [lib.php](../moodle-plugin/lib.php:27):
```php
debugging('Plugin certificados_sso: extend_navigation llamado para user ' . $USER->id, DEBUG_DEVELOPER);
```

2. Verificado que la funciÃ³n `extend_navigation` SÃ se estaba llamando
3. ConclusiÃ³n: El problema era de rendering del tema, no del plugin

**Causa raÃ­z:**
- Boost Union theme usa estructura de navegaciÃ³n diferente
- Los nodos agregados con `extend_navigation()` no se renderizan en la navegaciÃ³n principal
- El mÃ©todo estÃ¡ndar de Moodle funciona en Boost bÃ¡sico, pero no en Boost Union

---

#### 2.2 SoluciÃ³n con JavaScript Injection

**ImplementaciÃ³n:**
- Agregada funciÃ³n `local_certificados_sso_before_standard_top_of_body_html()` en [lib.php](../moodle-plugin/lib.php:90-182)
- Esta funciÃ³n inyecta JavaScript que agrega el enlace dinÃ¡micamente al DOM

**CÃ³digo de la funciÃ³n:**

```php
function local_certificados_sso_before_standard_top_of_body_html() {
    global $USER, $PAGE, $OUTPUT;

    // Solo mostrar para usuarios autenticados (no invitados)
    if (!isloggedin() || isguestuser()) {
        return '';
    }

    // Obtener configuraciÃ³n
    $app_url = get_config('local_certificados_sso', 'app_url');
    $dev_url = get_config('local_certificados_sso', 'dev_url');

    if (empty($app_url)) {
        $app_url = 'https://aulavirtual.acgcalidad.co/certificados/';
    }
    if (empty($dev_url)) {
        $dev_url = 'http://localhost:4200/';
    }

    // En modo debug, usar URL de desarrollo
    $debug_mode = get_config('local_certificados_sso', 'debug_mode');
    if ($debug_mode) {
        $app_url = $dev_url;
    }

    // Generar token temporal
    try {
        $token = local_certificados_sso_generate_token($USER->id);
        $redirect_url = $app_url . '?moodle_token=' . $token;
    } catch (Exception $e) {
        $redirect_url = $app_url;
    }

    // Inyectar JavaScript
    $js = "
    <script>
    (function() {
        document.addEventListener('DOMContentLoaded', function() {
            // Buscar navegaciÃ³n primaria con mÃºltiples selectores
            var nav = document.querySelector('.primary-navigation ul[role=\"menubar\"]');

            if (!nav) {
                nav = document.querySelector('nav#primary-navigation ul');
            }

            if (!nav) {
                nav = document.querySelector('.navbar-nav');
            }

            if (nav) {
                // Crear elemento de navegaciÃ³n
                var li = document.createElement('li');
                li.className = 'nav-item';

                var a = document.createElement('a');
                a.className = 'nav-link';
                a.href = '" . addslashes($redirect_url) . "';
                a.textContent = '" . addslashes(get_string('mycertificates', 'local_certificados_sso')) . "';
                a.title = '" . addslashes(get_string('mycertificates', 'local_certificados_sso')) . "';
                a.target = '_blank';
                a.rel = 'noopener noreferrer';

                li.appendChild(a);

                // Insertar despuÃ©s de 'Mis cursos'
                var mycourses = null;
                var items = nav.querySelectorAll('li.nav-item');
                for (var i = 0; i < items.length; i++) {
                    var link = items[i].querySelector('a');
                    if (link && (link.textContent.includes('Mis cursos') || link.textContent.includes('My courses'))) {
                        mycourses = items[i];
                        break;
                    }
                }

                if (mycourses && mycourses.nextSibling) {
                    nav.insertBefore(li, mycourses.nextSibling);
                } else {
                    nav.appendChild(li);
                }
            }
        });
    })();
    </script>
    ";

    return $js;
}
```

**CaracterÃ­sticas de la soluciÃ³n:**
- âœ… Funciona con Boost Union y Boost estÃ¡ndar
- âœ… Usa mÃºltiples selectores CSS para compatibilidad
- âœ… Inserta el enlace despuÃ©s de "Mis cursos"
- âœ… Genera token SSO nuevo en cada carga
- âœ… Abre en nueva pestaÃ±a (`target="_blank"`)
- âœ… Seguridad con `rel="noopener noreferrer"`

**Resultado:**
- âœ… Enlace aparece correctamente en el menÃº
- âœ… Posicionado despuÃ©s de "Mis cursos"
- âœ… Estilo consistente con otros items del menÃº

---

### 3. Ajustes de Debug Mode

#### 3.1 Problema con Mensajes de Debug

**Problema:**
- AparecÃ­an mensajes de debug persistentes incluso despuÃ©s de purgar cachÃ©s:
```
Plugin certificados_sso: extend_navigation llamado para user 2
```

**Causa:**
- El nivel de debug en [config.php](../moodle-files/config.php:47) estaba configurado como `E_ALL`
- Esto es equivalente a `DEBUG_DEVELOPER` que muestra todos los mensajes

---

#### 3.2 SoluciÃ³n

**Cambios en [config.php](../moodle-files/config.php:47-50):**

```php
// Antes:
$CFG->debug = E_ALL;
$CFG->debugdisplay = 1;

// DespuÃ©s:
$CFG->debug = 15;  // DEBUG_NORMAL
$CFG->debugdisplay = 0;  // No mostrar en pantalla
@error_reporting(E_ALL);
@ini_set('display_errors', '0');
```

**Nota importante:**
- No se puede usar la constante `DEBUG_NORMAL` en config.php
- Debe usarse el valor numÃ©rico `15`
- Las constantes de Moodle no estÃ¡n disponibles antes de `require_once('lib/setup.php')`

**Niveles de debug de Moodle:**
- `0` = NONE (sin debug)
- `5` = MINIMAL (errores crÃ­ticos)
- `15` = NORMAL (errores y warnings)
- `32767` = DEVELOPER (todo, incluyendo debugging())

---

#### 3.3 Desactivar Debug Statement en Plugin

**Cambio en [lib.php](../moodle-plugin/lib.php:27):**

```php
// Comentado el debugging statement
// debugging('Plugin certificados_sso: extend_navigation llamado para user ' . $USER->id, DEBUG_DEVELOPER);
```

**Resultado:**
- âœ… No mÃ¡s mensajes de debug en pantalla
- âœ… Errores importantes aÃºn se muestran en logs
- âœ… Ambiente mÃ¡s limpio para pruebas

---

### 4. PersonalizaciÃ³n del Enlace

#### 4.1 Remover Icono

**Solicitud del usuario:**
> "quiero que quites el Ã­cono antes del texto, creo que descuadra con la forma de los demÃ¡s elementos del menÃº"

**Cambio en [lib.php](../moodle-plugin/lib.php:149-156):**

```javascript
// CÃ³digo ANTES (con Ã­cono):
var icon = document.createElement('i');
icon.className = 'fa fa-certificate';
icon.style.marginRight = '5px';
a.appendChild(icon);
a.appendChild(document.createTextNode('My Certificates'));

// CÃ³digo DESPUÃ‰S (sin Ã­cono):
a.textContent = 'My Certificates';
```

**Resultado:**
- âœ… Enlace sin Ã­cono
- âœ… Consistente con otros items del menÃº
- âœ… Mejor integraciÃ³n visual

---

#### 4.2 Abrir en Nueva PestaÃ±a

**Solicitud del usuario:**
> "me gustarÃ­a que el enlace **Mis certificados** se abriera en una pestaÃ±a aparte, no en la misma donde estÃ¡ Moodle"

**Cambio en [lib.php](../moodle-plugin/lib.php:154-155):**

```javascript
a.target = '_blank';
a.rel = 'noopener noreferrer';
```

**Por quÃ© `noopener noreferrer`:**
- `noopener`: Previene que la nueva pestaÃ±a tenga acceso a `window.opener`
- `noreferrer`: No envÃ­a el header `Referer` (privacidad adicional)
- **Seguridad:** Previene ataques de "reverse tabnabbing"

**Resultado:**
- âœ… Enlace abre en nueva pestaÃ±a
- âœ… SesiÃ³n de Moodle permanece en pestaÃ±a original
- âœ… ImplementaciÃ³n segura

---

## ğŸ“Š Resumen de Archivos Modificados

### Plugin

| Archivo | Cambios |
|---------|---------|
| [moodle-plugin/lang/en/local_certificados_sso.php](../moodle-plugin/lang/en/local_certificados_sso.php) | âœ… Agregados strings para capabilities<br>âœ… Agregado string para scheduled task |
| [moodle-plugin/lib.php](../moodle-plugin/lib.php) | âœ… Agregada funciÃ³n `before_standard_top_of_body_html()`<br>âœ… JavaScript injection para Boost Union<br>âœ… Comentado debugging statement<br>âœ… Removido Ã­cono del enlace<br>âœ… Agregado `target="_blank"` |

### Archivos de ConfiguraciÃ³n

| Archivo | Cambios |
|---------|---------|
| [moodle-files/config.php](../moodle-files/config.php) | âœ… Debug level: `15` (NORMAL)<br>âœ… debugdisplay: `0` |

### DocumentaciÃ³n

| Archivo | Cambios |
|---------|---------|
| [docs/SESION-2026-01-10.md](../docs/SESION-2026-01-10.md) | âœ… **NUEVO** - Este documento |

---

## ğŸ¯ Estado Actual del Proyecto

### âœ… Completado

- [x] Ambiente Docker local funcionando
- [x] Moodle 5.1 clonado y configurado
- [x] Plugin SSO instalado
- [x] Language strings completos
- [x] **Web Services habilitados**
- [x] **Servicio "ACG Certificados SSO" creado**
- [x] **Token permanente generado**
- [x] **URLs del plugin configuradas**
- [x] **Enlace "Mis Certificados" visible en menÃº**
- [x] **Tarea programada verificada**
- [x] Debug mode ajustado
- [x] Enlace personalizado (sin Ã­cono, nueva pestaÃ±a)

### âœ… Verificaciones Finales del Plugin

- [x] Web Services: **Habilitado** âœ…
- [x] Protocolo REST: **Activo** âœ…
- [x] Servicio externo: **Creado con 2 funciones** âœ…
- [x] Token permanente: **Generado y guardado** âœ…
- [x] ConfiguraciÃ³n URLs: **Completada** âœ…
- [x] Enlace en navegaciÃ³n: **Visible y funcional** âœ…
- [x] Tarea programada: **Habilitada (cada 15 min)** âœ…

**Estado del Plugin:** ğŸŸ¢ **COMPLETAMENTE CONFIGURADO**

---

## ğŸ“ Tareas Pendientes para MaÃ±ana

### 1. Desarrollo del Backend (PRIORIDAD ALTA)

**Objetivo:** Crear API REST que valide tokens SSO y gestione certificados

**UbicaciÃ³n:** `backend/`

---

#### 1.1 Estructura del Proyecto Backend

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ database.php      # ConfiguraciÃ³n de conexiÃ³n a BD
â”‚   â”‚   â””â”€â”€ moodle.php         # ConfiguraciÃ³n de Web Service Moodle
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ AuthController.php          # ValidaciÃ³n de tokens SSO
â”‚   â”‚   â””â”€â”€ CertificatesController.php  # GestiÃ³n de certificados
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ User.php           # Modelo de usuario
â”‚   â”‚   â””â”€â”€ Certificate.php    # Modelo de certificado
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ MoodleService.php  # Cliente para Moodle Web Service
â”‚   â”‚   â””â”€â”€ CertificateService.php  # LÃ³gica de negocio
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ Response.php       # Helpers para respuestas JSON
â”‚       â””â”€â”€ Logger.php         # Sistema de logging
â”œâ”€â”€ public/
â”‚   â””â”€â”€ index.php              # Entry point de la API
â”œâ”€â”€ .env                       # Variables de entorno
â”œâ”€â”€ composer.json              # Dependencias PHP
â””â”€â”€ README.md                  # DocumentaciÃ³n del backend
```

---

#### 1.2 ConfiguraciÃ³n Inicial

**Tarea 1: Crear archivo .env**

```env
# Base de datos
DB_HOST=mariadb
DB_PORT=3306
DB_NAME=moodle_dev
DB_USER=moodle_user
DB_PASSWORD=moodle_password_dev
DB_PREFIX=mdl_

# Moodle Web Service
MOODLE_URL=http://moodle:80
MOODLE_WS_TOKEN=<TOKEN_GENERADO_HOY>
MOODLE_WS_FUNCTION_VALIDATE=local_certificados_sso_validate_token

# API
API_DEBUG=true
API_LOG_PATH=/var/www/backend/logs
API_CORS_ORIGIN=http://localhost:4200

# Certificados
CERTIFICATES_STORAGE_PATH=/var/www/backend/storage/certificates
CERTIFICATES_TABLE=local_certificates  # Tabla a crear
```

**Tarea 2: Crear composer.json**

```json
{
    "name": "acg/certificados-backend",
    "description": "Backend API para sistema de certificados ACG",
    "type": "project",
    "require": {
        "php": ">=8.1",
        "vlucas/phpdotenv": "^5.5",
        "monolog/monolog": "^3.0"
    },
    "autoload": {
        "psr-4": {
            "ACG\\Certificados\\": "src/"
        }
    }
}
```

**Tarea 3: Instalar dependencias**

```bash
cd backend
docker-compose exec moodle composer install
```

---

#### 1.3 Implementar MoodleService

**Archivo:** `backend/src/services/MoodleService.php`

**Responsabilidades:**
- Comunicarse con Moodle Web Service
- Validar tokens SSO
- Obtener informaciÃ³n de usuarios

**MÃ©todos principales:**

```php
<?php
namespace ACG\Certificados\Services;

class MoodleService {
    private string $moodleUrl;
    private string $wsToken;

    public function __construct() {
        $this->moodleUrl = $_ENV['MOODLE_URL'];
        $this->wsToken = $_ENV['MOODLE_WS_TOKEN'];
    }

    /**
     * Validar token SSO contra Moodle
     *
     * @param string $ssoToken Token generado por el plugin
     * @return array|false Datos del usuario o false si invÃ¡lido
     */
    public function validateSSOToken(string $ssoToken): array|false {
        $params = [
            'wstoken' => $this->wsToken,
            'wsfunction' => 'local_certificados_sso_validate_token',
            'moodlewsrestformat' => 'json',
            'token' => $ssoToken
        ];

        $url = $this->moodleUrl . '/webservice/rest/server.php?' . http_build_query($params);

        $response = file_get_contents($url);
        $data = json_decode($response, true);

        if (isset($data['valid']) && $data['valid']) {
            return $data;
        }

        return false;
    }

    /**
     * Obtener informaciÃ³n de usuario de Moodle
     *
     * @param int $userid ID del usuario en Moodle
     * @return array|false Datos del usuario
     */
    public function getUserInfo(int $userid): array|false {
        $params = [
            'wstoken' => $this->wsToken,
            'wsfunction' => 'core_user_get_users_by_field',
            'moodlewsrestformat' => 'json',
            'field' => 'id',
            'values[0]' => $userid
        ];

        $url = $this->moodleUrl . '/webservice/rest/server.php?' . http_build_query($params);

        $response = file_get_contents($url);
        $data = json_decode($response, true);

        if (!empty($data) && isset($data[0])) {
            return $data[0];
        }

        return false;
    }
}
```

---

#### 1.4 Implementar AuthController

**Archivo:** `backend/src/controllers/AuthController.php`

**Endpoint:** `POST /api/auth/validate`

**Request:**
```json
{
  "token": "abc123def456..."
}
```

**Response exitosa (200):**
```json
{
  "success": true,
  "data": {
    "userid": 2,
    "username": "adminav",
    "firstname": "Admin",
    "lastname": "AV",
    "email": "admin@acgcalidad.co",
    "role": "admin"
  },
  "message": "Token vÃ¡lido"
}
```

**Response error (401):**
```json
{
  "success": false,
  "error": "Token invÃ¡lido o expirado",
  "code": "INVALID_TOKEN"
}
```

**CÃ³digo:**

```php
<?php
namespace ACG\Certificados\Controllers;

use ACG\Certificados\Services\MoodleService;
use ACG\Certificados\Utils\Response;

class AuthController {
    private MoodleService $moodleService;

    public function __construct() {
        $this->moodleService = new MoodleService();
    }

    public function validateToken() {
        // Obtener token del request
        $input = json_decode(file_get_contents('php://input'), true);

        if (!isset($input['token']) || empty($input['token'])) {
            Response::error('Token no proporcionado', 400, 'MISSING_TOKEN');
            return;
        }

        $token = $input['token'];

        // Validar con Moodle
        $userData = $this->moodleService->validateSSOToken($token);

        if (!$userData) {
            Response::error('Token invÃ¡lido o expirado', 401, 'INVALID_TOKEN');
            return;
        }

        // Retornar datos del usuario
        Response::success($userData, 'Token vÃ¡lido');
    }
}
```

---

#### 1.5 Implementar CertificatesController

**Archivo:** `backend/src/controllers/CertificatesController.php`

**Endpoints:**

1. **GET /api/certificates/user/:userid**
   - Lista certificados del usuario
   - Consulta BD de Moodle

2. **GET /api/certificates/:id/download**
   - Descarga PDF del certificado
   - Desde storage o genera on-the-fly

**CÃ³digo bÃ¡sico:**

```php
<?php
namespace ACG\Certificados\Controllers;

use ACG\Certificados\Services\CertificateService;
use ACG\Certificados\Utils\Response;

class CertificatesController {
    private CertificateService $certificateService;

    public function __construct() {
        $this->certificateService = new CertificateService();
    }

    /**
     * Listar certificados de un usuario
     */
    public function listByUser(int $userid) {
        $certificates = $this->certificateService->getUserCertificates($userid);

        Response::success($certificates, 'Certificados obtenidos');
    }

    /**
     * Descargar certificado en PDF
     */
    public function download(int $certificateId) {
        $certificate = $this->certificateService->getCertificate($certificateId);

        if (!$certificate) {
            Response::error('Certificado no encontrado', 404, 'NOT_FOUND');
            return;
        }

        // TODO: Generar o servir PDF
        // Por ahora, retornar datos del certificado
        Response::success($certificate);
    }
}
```

---

#### 1.6 Implementar Response Helper

**Archivo:** `backend/src/utils/Response.php`

```php
<?php
namespace ACG\Certificados\Utils;

class Response {
    public static function success($data, string $message = '', int $status = 200) {
        http_response_code($status);
        header('Content-Type: application/json');

        echo json_encode([
            'success' => true,
            'data' => $data,
            'message' => $message
        ], JSON_PRETTY_PRINT);

        exit;
    }

    public static function error(string $message, int $status = 400, string $code = '') {
        http_response_code($status);
        header('Content-Type: application/json');

        $response = [
            'success' => false,
            'error' => $message
        ];

        if (!empty($code)) {
            $response['code'] = $code;
        }

        echo json_encode($response, JSON_PRETTY_PRINT);

        exit;
    }
}
```

---

#### 1.7 Crear Entry Point (index.php)

**Archivo:** `backend/public/index.php`

```php
<?php
require_once __DIR__ . '/../vendor/autoload.php';

use ACG\Certificados\Controllers\AuthController;
use ACG\Certificados\Controllers\CertificatesController;

// Cargar variables de entorno
$dotenv = Dotenv\Dotenv::createImmutable(__DIR__ . '/..');
$dotenv->load();

// Headers CORS
header('Access-Control-Allow-Origin: ' . $_ENV['API_CORS_ORIGIN']);
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, Authorization');

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit;
}

// Router simple
$requestUri = $_SERVER['REQUEST_URI'];
$requestMethod = $_SERVER['REQUEST_METHOD'];

// Remover query string
$requestUri = strtok($requestUri, '?');

// Routing
match(true) {
    // Auth
    $requestMethod === 'POST' && $requestUri === '/api/auth/validate' =>
        (new AuthController())->validateToken(),

    // Certificates - List by user
    $requestMethod === 'GET' && preg_match('#^/api/certificates/user/(\d+)$#', $requestUri, $matches) =>
        (new CertificatesController())->listByUser((int)$matches[1]),

    // Certificates - Download
    $requestMethod === 'GET' && preg_match('#^/api/certificates/(\d+)/download$#', $requestUri, $matches) =>
        (new CertificatesController())->download((int)$matches[1]),

    // Default - 404
    default => (function() {
        http_response_code(404);
        echo json_encode(['error' => 'Endpoint not found']);
    })()
};
```

---

#### 1.8 Testing del Backend

**Herramienta:** Postman o cURL

**Test 1: Validar token SSO**

```bash
# Primero, obtener un token desde Moodle
# 1. Ir a http://localhost:8082
# 2. Login como adminav
# 3. Hacer clic en "Mis Certificados"
# 4. Copiar el token de la URL: ?moodle_token=XXXXX

# Luego, probar el endpoint
curl -X POST http://localhost:8080/api/auth/validate \
  -H "Content-Type: application/json" \
  -d '{"token": "XXXXX"}'

# Respuesta esperada:
# {
#   "success": true,
#   "data": {
#     "valid": true,
#     "userid": 2,
#     "username": "adminav",
#     ...
#   }
# }
```

**Test 2: Listar certificados (pendiente de implementar)**

```bash
curl http://localhost:8080/api/certificates/user/2

# Respuesta esperada (cuando estÃ© implementado):
# {
#   "success": true,
#   "data": [
#     {
#       "id": 1,
#       "name": "Certificado de Curso X",
#       "coursename": "Curso de Ejemplo",
#       ...
#     }
#   ]
# }
```

---

### 2. Actualizar docker-compose.yml (PRIORIDAD ALTA)

Agregar servicio del backend al docker-compose:

```yaml
# Agregar a docker-compose.yml
backend:
  build:
    context: .
    dockerfile: docker/php/Dockerfile
  container_name: acg-backend
  ports:
    - "8080:80"
  volumes:
    - ./backend:/var/www/backend:cached
    - ./docker/logs/backend:/var/log/apache2
  environment:
    - APACHE_DOCUMENT_ROOT=/var/www/backend/public
  networks:
    - acg-network
  depends_on:
    - mariadb
    - moodle
  restart: unless-stopped
```

---

### 3. Desarrollo del Frontend (PRIORIDAD MEDIA)

**DespuÃ©s de que el backend estÃ© funcionando**

#### 3.1 Crear proyecto Angular

```bash
cd frontend
ng new acg-certificados --routing --style=scss
cd acg-certificados
```

#### 3.2 Estructura de componentes

```
frontend/src/app/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”‚   â””â”€â”€ certificates.service.ts
â”‚   â”œâ”€â”€ guards/
â”‚   â”‚   â””â”€â”€ auth.guard.ts
â”‚   â””â”€â”€ interceptors/
â”‚       â””â”€â”€ auth.interceptor.ts
â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â””â”€â”€ login/
â”‚   â”‚       â””â”€â”€ login.component.ts
â”‚   â””â”€â”€ certificates/
â”‚       â”œâ”€â”€ list/
â”‚       â”‚   â””â”€â”€ certificates-list.component.ts
â”‚       â””â”€â”€ detail/
â”‚           â””â”€â”€ certificate-detail.component.ts
â”œâ”€â”€ shared/
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ header/
â”‚       â””â”€â”€ loading/
â””â”€â”€ app-routing.module.ts
```

#### 3.3 AuthService

```typescript
// frontend/src/app/core/services/auth.service.ts
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable, BehaviorSubject } from 'rxjs';
import { tap } from 'rxjs/operators';

export interface User {
  userid: number;
  username: string;
  firstname: string;
  lastname: string;
  email: string;
  role: string;
}

@Injectable({
  providedIn: 'root'
})
export class AuthService {
  private apiUrl = 'http://localhost:8080/api';
  private currentUserSubject = new BehaviorSubject<User | null>(null);
  public currentUser$ = this.currentUserSubject.asObservable();

  constructor(private http: HttpClient) {
    // Cargar usuario desde localStorage si existe
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
      this.currentUserSubject.next(JSON.parse(savedUser));
    }
  }

  validateToken(token: string): Observable<any> {
    return this.http.post(`${this.apiUrl}/auth/validate`, { token }).pipe(
      tap((response: any) => {
        if (response.success) {
          this.currentUserSubject.next(response.data);
          localStorage.setItem('currentUser', JSON.stringify(response.data));
        }
      })
    );
  }

  logout(): void {
    this.currentUserSubject.next(null);
    localStorage.removeItem('currentUser');
  }

  isAuthenticated(): boolean {
    return this.currentUserSubject.value !== null;
  }

  getCurrentUser(): User | null {
    return this.currentUserSubject.value;
  }
}
```

#### 3.4 LoginComponent

```typescript
// frontend/src/app/features/auth/login/login.component.ts
import { Component, OnInit } from '@angular/core';
import { ActivatedRoute, Router } from '@angular/router';
import { AuthService } from '../../../core/services/auth.service';

@Component({
  selector: 'app-login',
  template: `
    <div class="login-container">
      <div *ngIf="loading" class="loading">
        <p>Validando token SSO...</p>
      </div>

      <div *ngIf="error" class="error">
        <h2>Error de autenticaciÃ³n</h2>
        <p>{{ error }}</p>
        <button (click)="redirectToMoodle()">Volver a Moodle</button>
      </div>
    </div>
  `
})
export class LoginComponent implements OnInit {
  loading = true;
  error: string | null = null;

  constructor(
    private route: ActivatedRoute,
    private router: Router,
    private authService: AuthService
  ) {}

  ngOnInit(): void {
    // Obtener token de la URL
    this.route.queryParams.subscribe(params => {
      const token = params['moodle_token'];

      if (!token) {
        this.error = 'Token SSO no proporcionado';
        this.loading = false;
        return;
      }

      // Validar token con el backend
      this.authService.validateToken(token).subscribe({
        next: (response) => {
          this.loading = false;
          // Redirigir a la lista de certificados
          this.router.navigate(['/certificates']);
        },
        error: (err) => {
          this.loading = false;
          this.error = err.error?.error || 'Error al validar el token';
        }
      });
    });
  }

  redirectToMoodle(): void {
    window.location.href = 'http://localhost:8082';
  }
}
```

---

### 4. Testing de IntegraciÃ³n Completa

Una vez que backend y frontend estÃ©n listos:

#### 4.1 Flujo Completo SSO

**Test manual:**

1. âœ… Abrir Moodle: http://localhost:8082
2. âœ… Login como `adminav`
3. âœ… Hacer clic en "Mis Certificados" en el menÃº
4. âœ… Verificar que abre nueva pestaÃ±a con URL: `http://localhost:4200?moodle_token=XXX`
5. âœ… Frontend captura token
6. âœ… Frontend envÃ­a token a backend
7. âœ… Backend valida con Moodle Web Service
8. âœ… Backend retorna datos del usuario
9. âœ… Frontend muestra interfaz de certificados

---

### 5. DocumentaciÃ³n API (PRIORIDAD BAJA)

Crear documento `backend/API.md` con:

- Lista de endpoints
- Formato de request/response
- CÃ³digos de error
- Ejemplos con cURL

---

## ğŸ’¡ Lecciones Aprendidas Hoy

### 1. Boost Union Theme Requiere Enfoque Diferente

**Problema:**
- Los mÃ©todos estÃ¡ndar de Moodle (`extend_navigation`) no funcionan con todos los temas
- Boost Union usa estructura de navegaciÃ³n diferente

**SoluciÃ³n:**
- JavaScript injection usando `before_standard_top_of_body_html()`
- MÃºltiples selectores CSS para compatibilidad
- Enfoque mÃ¡s robusto que funciona en mÃ¡s escenarios

### 2. Language Strings son Obligatorios para TODO

**Aprendizaje:**
- No solo para UI, tambiÃ©n para capabilities y scheduled tasks
- Moodle NO renderiza NADA sin el language string correspondiente
- Verificar siempre que todos los strings estÃ©n definidos

### 3. Debug Levels de Moodle en config.php

**Importante:**
- NO usar constantes de Moodle en config.php (no estÃ¡n disponibles aÃºn)
- Usar valores numÃ©ricos directos:
  - `0` = NONE
  - `5` = MINIMAL
  - `15` = NORMAL
  - `32767` = DEVELOPER

### 4. Seguridad en Enlaces Externos

**Best Practice:**
- Siempre usar `rel="noopener noreferrer"` con `target="_blank"`
- Previene ataques de "reverse tabnabbing"
- Mejora privacidad del usuario

---

## ğŸ› Issues Conocidos

### Plugin funciona solo con JavaScript habilitado

**DescripciÃ³n:**
- El enlace "Mis Certificados" se agrega con JavaScript
- Si un usuario tiene JavaScript deshabilitado, no verÃ¡ el enlace

**Impacto:** Bajo (99% de usuarios tienen JavaScript habilitado)

**SoluciÃ³n futura (opcional):**
- Crear custom renderer para Boost Union theme
- Esto requerirÃ­a modificar el tema, no ideal

**DecisiÃ³n:** Mantener soluciÃ³n actual (JavaScript injection)

---

## ğŸ“ InformaciÃ³n Importante

### Token Permanente Moodle

**Generado hoy:** *(guardado de forma segura)*

**Uso:** Configurar en `backend/.env` como `MOODLE_WS_TOKEN`

**Seguridad:**
- No compartir pÃºblicamente
- No incluir en repositorio Git
- Usar `.env.example` en Git, `.env` en `.gitignore`

### URLs del Proyecto

| Servicio | URL | Estado |
|----------|-----|--------|
| Moodle Local | http://localhost:8082 | âœ… Funcionando |
| Backend API | http://localhost:8080 | â³ Por implementar |
| Frontend Angular | http://localhost:4200 | â³ Por implementar |
| phpMyAdmin | http://localhost:8081 | âœ… Funcionando |

---

## ğŸ‰ Conclusiones

SesiÃ³n exitosa donde se completÃ³ toda la configuraciÃ³n del plugin SSO:

### Logros de Hoy:

1. âœ… Completados todos los pasos del manual de configuraciÃ³n
2. âœ… Resueltos errores de language strings
3. âœ… Implementada soluciÃ³n para Boost Union theme
4. âœ… Ajustado modo debug apropiadamente
5. âœ… Personalizado enlace segÃºn requerimientos del usuario
6. âœ… Plugin 100% funcional y configurado

### Estado del Proyecto:

**Plugin Moodle:** ğŸŸ¢ COMPLETADO
**Backend API:** ğŸ”´ PENDIENTE
**Frontend Angular:** ğŸ”´ PENDIENTE
**IntegraciÃ³n:** ğŸ”´ PENDIENTE

### PrÃ³ximos Pasos Inmediatos:

1. **MaÃ±ana:** Iniciar desarrollo del backend
2. **Prioridad:** Endpoint de validaciÃ³n de tokens
3. **Testing:** Probar flujo SSO completo
4. **Meta:** Backend funcional en 1 dÃ­a

---

**Tiempo estimado para backend completo:** 4-6 horas
**Tiempo estimado para frontend bÃ¡sico:** 4-5 horas
**Tiempo estimado para integraciÃ³n y testing:** 2-3 horas

**Total estimado para MVP funcional:** 10-14 horas (2-3 dÃ­as)

---

*Documentado por: Oliver Castelblanco*
*Fecha: 2026-01-10*
*PrÃ³xima sesiÃ³n: 2026-01-13 (lunes)*
*Inicio con: Desarrollo del Backend (SecciÃ³n 1.1)*
